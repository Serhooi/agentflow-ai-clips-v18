# –ü–ª–∞–Ω –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ Render.com –¥–ª—è 100+ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

## –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
- ‚úÖ –ü—Ä–æ–¥—É–∫—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ Render.com
- ‚úÖ 512MB RAM –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
- ‚úÖ –ì–∏–±—Ä–∏–¥–Ω–∞—è –æ—á–µ—Ä–µ–¥—å (–ø–∞–º—è—Ç—å/Redis)
- ‚úÖ –õ–∏–º–∏—Ç: 2 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏

## –≠—Ç–∞–ø 1: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ Redis (–±–µ–∑ –ø—Ä–æ—Å—Ç–æ—è)

### 1.1 –î–æ–±–∞–≤–∏—Ç—å Redis —Å–µ—Ä–≤–∏—Å –≤ Render.com

–í Render Dashboard:
1. **New** ‚Üí **Redis**
2. **Name:** `agentflow-redis`
3. **Plan:** `Starter` ($7/–º–µ—Å—è—Ü, 25MB)
4. **Region:** —Ç–æ—Ç –∂–µ —á—Ç–æ –∏ –æ—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å

### 1.2 –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è

–í –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö Web Service:
```
REDIS_URL=redis://red-xxxxx:6379
```
(URL —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∏–∑ Redis —Å–µ—Ä–≤–∏—Å–∞)

### 1.3 –†–µ–∑—É–ª—å—Ç–∞—Ç
- –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—Å—è –Ω–∞ Redis
- –û—á–µ—Ä–µ–¥—å —Å—Ç–∞–Ω–µ—Ç –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–π
- –ù–∏–∫–∞–∫–æ–≥–æ –ø—Ä–æ—Å—Ç–æ—è!

## –≠—Ç–∞–ø 2: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤–æ—Ä–∫–µ—Ä–æ–≤ (–º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ)

### 2.1 –°–æ–∑–¥–∞—Ç—å Background Worker —Å–µ—Ä–≤–∏—Å

–í Render Dashboard:
1. **New** ‚Üí **Background Worker**
2. **Name:** `agentflow-worker-1`
3. **Build Command:** `pip install -r requirements.txt`
4. **Start Command:** `python worker.py`
5. **Instance Type:** `Starter` (512MB, $7/–º–µ—Å—è—Ü)

### 2.2 –°–æ–∑–¥–∞—Ç—å worker.py

```python
# worker.py - –í–æ—Ä–∫–µ—Ä –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–¥–∞—á
import asyncio
import logging
from app import hybrid_queue, analyze_video_internal

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger("worker")

async def worker_main():
    """–û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –≤–æ—Ä–∫–µ—Ä–∞"""
    logger.info("üîÑ –í–æ—Ä–∫–µ—Ä –∑–∞–ø—É—â–µ–Ω")
    
    while True:
        try:
            # –ü–æ–ª—É—á–∞–µ–º –∑–∞–¥–∞—á—É –∏–∑ –æ—á–µ—Ä–µ–¥–∏
            task = hybrid_queue.get_task()
            
            if task:
                task_id = task["task_id"]
                video_id = task["video_id"]
                
                logger.info(f"üé¨ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∑–∞–¥–∞—á—É: {task_id}")
                
                try:
                    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤–∏–¥–µ–æ
                    result = await analyze_video_internal(video_id)
                    
                    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                    hybrid_queue.complete_task(task_id, {
                        "status": "completed",
                        "result": result,
                        "completed_at": datetime.now().isoformat()
                    })
                    
                    logger.info(f"‚úÖ –ó–∞–¥–∞—á–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞: {task_id}")
                    
                except Exception as e:
                    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—à–∏–±–∫—É
                    hybrid_queue.complete_task(task_id, {
                        "status": "failed",
                        "error": str(e),
                        "failed_at": datetime.now().isoformat()
                    })
                    logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–¥–∞—á–∏ {task_id}: {e}")
            else:
                # –ï—Å–ª–∏ –∑–∞–¥–∞—á –Ω–µ—Ç, –∂–¥–µ–º
                await asyncio.sleep(2)
                
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤–æ—Ä–∫–µ—Ä–∞: {e}")
            await asyncio.sleep(5)

if __name__ == "__main__":
    asyncio.run(worker_main())
```

### 2.3 –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–æ—Ä–∫–µ—Ä–æ–≤

–°–æ–∑–¥–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–æ—Ä–∫–µ—Ä–æ–≤:
- `agentflow-worker-1` 
- `agentflow-worker-2`
- `agentflow-worker-3`

**–ò—Ç–æ–≥–æ:** 3 –≤–æ—Ä–∫–µ—Ä–∞ √ó 2 –∑–∞–¥–∞—á–∏ = 6 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á

## –≠—Ç–∞–ø 3: –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è API (–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –æ—á–µ—Ä–µ–¥—å)

### 3.1 –ò–∑–º–µ–Ω–∏—Ç—å —ç–Ω–¥–ø–æ–∏–Ω—Ç –∞–Ω–∞–ª–∏–∑–∞

–í–º–µ—Å—Ç–æ –ø—Ä—è–º–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ ‚Üí –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –æ—á–µ—Ä–µ–¥—å:

```python
@app.post("/api/videos/analyze")
async def analyze_video_queue(request: AnalyzeRequest):
    """–ê–Ω–∞–ª–∏–∑ —á–µ—Ä–µ–∑ –æ—á–µ—Ä–µ–¥—å"""
    try:
        # –î–æ–±–∞–≤–ª—è–µ–º –≤ –æ—á–µ—Ä–µ–¥—å –≤–º–µ—Å—Ç–æ –ø—Ä—è–º–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
        task_id = hybrid_queue.add_task({
            "video_id": request.video_id,
            "type": "analyze"
        })
        
        return {
            "task_id": task_id,
            "status": "queued",
            "message": "–ó–∞–¥–∞—á–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –æ—á–µ—Ä–µ–¥—å"
        }
        
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

@app.get("/api/videos/task/{task_id}/status")
async def get_task_status_queue(task_id: str):
    """–°—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏ –∏–∑ –æ—á–µ—Ä–µ–¥–∏"""
    result = hybrid_queue.get_task_result(task_id)
    
    if not result:
        return {"status": "processing", "progress": 0}
    
    return result
```

## –†–µ–∑—É–ª—å—Ç–∞—Ç –º–∏–≥—Ä–∞—Ü–∏–∏

### –î–æ –º–∏–≥—Ä–∞—Ü–∏–∏:
- **–ü—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å:** 2 –∑–∞–¥–∞—á–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:** ~5-10 –∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ
- **–°—Ç–æ–∏–º–æ—Å—Ç—å:** $7/–º–µ—Å—è—Ü

### –ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏:
- **–ü—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å:** 6-10 –∑–∞–¥–∞—á –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ  
- **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:** 50-80 –∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ
- **–°—Ç–æ–∏–º–æ—Å—Ç—å:** $35/–º–µ—Å—è—Ü ($7 API + $7 Redis + $21 –≤–æ—Ä–∫–µ—Ä—ã)

### –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è:
- –î–æ–±–∞–≤–∏—Ç—å –µ—â–µ –≤–æ—Ä–∫–µ—Ä–æ–≤ (–ø–æ $7 –∫–∞–∂–¥—ã–π)
- –£–≤–µ–ª–∏—á–∏—Ç—å Redis –ø–ª–∞–Ω
- **100+ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:** ~$50-70/–º–µ—Å—è—Ü

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ù–æ–≤—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã:
- `GET /api/system/queue-stats` - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—á–µ—Ä–µ–¥–∏
- `GET /health` - —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
- `GET /api/system/stats` - –¥–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

### –ê–ª–µ—Ä—Ç—ã:
- –î–ª–∏–Ω–∞ –æ—á–µ—Ä–µ–¥–∏ > 10 –∑–∞–¥–∞—á
- –ü–∞–º—è—Ç—å > 80%
- –í–æ—Ä–∫–µ—Ä—ã –Ω–µ –æ—Ç–≤–µ—á–∞—é—Ç

## Rollback –ø–ª–∞–Ω

–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ–π–¥–µ—Ç –Ω–µ —Ç–∞–∫:
1. –£–±—Ä–∞—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `REDIS_URL`
2. –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–µ—Ä–Ω–µ—Ç—Å—è –∫ –ø–∞–º—è—Ç–∏
3. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤–æ—Ä–∫–µ—Ä—ã
4. –í—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ —Ä–∞–Ω—å—à–µ!

## –í—Ä–µ–º–µ–Ω–Ω–∞—è —à–∫–∞–ª–∞

- **–î–µ–Ω—å 1:** –î–æ–±–∞–≤–∏—Ç—å Redis (5 –º–∏–Ω—É—Ç)
- **–î–µ–Ω—å 2:** –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤–æ–≥–æ –≤–æ—Ä–∫–µ—Ä–∞
- **–î–µ–Ω—å 3:** –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–≥—Ä—É–∑–∫—É
- **–î–µ–Ω—å 4:** –î–æ–±–∞–≤–∏—Ç—å –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –≤–æ—Ä–∫–µ—Ä–æ–≤
- **–î–µ–Ω—å 5:** –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å API –Ω–∞ –æ—á–µ—Ä–µ–¥—å

**–ò—Ç–æ–≥–æ:** 1 –Ω–µ–¥–µ–ª—è –±–µ–∑ –ø—Ä–æ—Å—Ç–æ—è —Å–µ—Ä–≤–∏—Å–∞!